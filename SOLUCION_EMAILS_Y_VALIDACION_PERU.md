# üáµüá™ SOLUCI√ìN: Emails √önicos y Validaci√≥n de Documentos Peruanos

**Fecha:** 2025-10-10
**Prioridad:** üî¥ CR√çTICA

---

## üéØ DECISIONES CLAVE

### 1Ô∏è‚É£ **Responsable NO tiene acceso al sistema**
‚úÖ **Decisi√≥n:** Eliminar completamente la relaci√≥n `Usuario` en `Responsable`.

**Antes:**
```python
class Responsable(models.Model):
    email = models.EmailField(...)
    usuario = models.OneToOneField(Usuario, ...)  # ‚ùå INNECESARIO
```

**Despu√©s:**
```python
class Responsable(models.Model):
    email = models.EmailField(unique=True)  # ‚úÖ Solo un email
    # No hay campo usuario
```

---

### 2Ô∏è‚É£ **Trabajador S√ç tiene acceso (debe hacer login)**
‚úÖ **Decisi√≥n:** Eliminar campo `Trabajador.email` redundante, usar solo `Usuario.email`.

**Antes:**
```python
class Trabajador(models.Model):
    email = models.EmailField()  # ‚ùå REDUNDANTE
    usuario = models.OneToOneField(Usuario, ...)  # Usuario.email
```

**Despu√©s:**
```python
class Trabajador(models.Model):
    # No hay campo email directo
    usuario = models.OneToOneField(Usuario, ...)  # ‚úÖ Solo Usuario.email

    @property
    def email(self):
        """Email viene del Usuario"""
        return self.usuario.email
```

---

### 3Ô∏è‚É£ **Validaci√≥n de Documentos Peruanos**

#### Tipos de Documento en Per√∫:
- **DNI** (Documento Nacional de Identidad): 8 d√≠gitos exactos
- **CE** (Carnet de Extranjer√≠a): 9 d√≠gitos
- **Pasaporte**: Alfanum√©rico, 9-12 caracteres
- **RUC** (Registro √önico de Contribuyentes): 11 d√≠gitos

‚úÖ **Decisi√≥n:** Implementar validaci√≥n espec√≠fica por tipo de documento.

---

## üìù CAMBIOS EN MODELOS

### **1. Modelo Trabajador (Refactorizado)**

```python
class Trabajador(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    nombres = models.CharField(max_length=100)
    apellidos = models.CharField(max_length=100)
    # ‚ùå ELIMINADO: email = models.EmailField()
    telefono = models.CharField(max_length=20)
    tipodocumento = models.ForeignKey(
        TipoDocumento,
        on_delete=models.CASCADE,
        related_name='trabajadores'
    )
    documento = models.CharField(max_length=20)
    usuario = models.OneToOneField(
        Usuario,
        on_delete=models.CASCADE,
        related_name='trabajador'
    )
    estado = models.CharField(
        max_length=10,
        choices=Estado.ESTADO_CHOICES,
        default=Estado.ACTIVO,
    )

    class Meta:
        ordering = ['nombres']
        constraints = [
            # Documento √∫nico por tipo
            models.UniqueConstraint(
                fields=['tipodocumento', 'documento'],
                name='unique_trabajador_documento',
                violation_error_message='Ya existe un trabajador con este documento.'
            ),
        ]

    def __str__(self):
        return f"{self.nombres} {self.apellidos}"

    @property
    def email(self):
        """
        Email viene del Usuario (para login).
        Mantiene compatibilidad con c√≥digo existente.
        """
        return self.usuario.email if self.usuario else None

    def clean(self):
        """
        Validaci√≥n de documento seg√∫n tipo (Per√∫)
        """
        super().clean()

        if self.documento and self.tipodocumento:
            tipo = self.tipodocumento.nombre.upper()
            doc = self.documento.strip()

            # DNI: 8 d√≠gitos exactos
            if tipo == 'DNI':
                if not re.match(r'^\d{8}$', doc):
                    raise CoreValidationError({
                        'documento': 'El DNI debe tener exactamente 8 d√≠gitos.'
                    })

            # Carnet de Extranjer√≠a: 9 d√≠gitos
            elif tipo in ['CE', 'CARNET DE EXTRANJERIA', 'CARNET DE EXTRANJER√çA']:
                if not re.match(r'^\d{9}$', doc):
                    raise CoreValidationError({
                        'documento': 'El Carnet de Extranjer√≠a debe tener 9 d√≠gitos.'
                    })

            # Pasaporte: Alfanum√©rico, 9-12 caracteres
            elif tipo == 'PASAPORTE':
                if not re.match(r'^[A-Z0-9]{9,12}$', doc):
                    raise CoreValidationError({
                        'documento': 'El Pasaporte debe tener entre 9 y 12 caracteres alfanum√©ricos.'
                    })

            # RUC: 11 d√≠gitos
            elif tipo == 'RUC':
                if not re.match(r'^\d{11}$', doc):
                    raise CoreValidationError({
                        'documento': 'El RUC debe tener exactamente 11 d√≠gitos.'
                    })

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)
```

---

### **2. Modelo Responsable (Refactorizado)**

```python
class Responsable(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    nombres = models.CharField(max_length=100)
    apellidos = models.CharField(max_length=100)
    email = models.EmailField(
        max_length=254,
        unique=True,
        help_text="Email del responsable (para contacto)",
        db_index=True
    )
    telefono = models.CharField(max_length=20)
    direccion = models.CharField(max_length=255)
    ciudad = models.CharField(max_length=100)
    documento = models.CharField(max_length=20)
    tipodocumento = models.ForeignKey(
        TipoDocumento,
        on_delete=models.CASCADE,
        related_name='responsables'
    )
    emergencia = models.CharField(max_length=100, blank=True, null=True)
    # ‚ùå ELIMINADO: usuario = models.OneToOneField(Usuario, ...)

    class Meta:
        ordering = ['nombres']
        constraints = [
            # Documento √∫nico por tipo
            models.UniqueConstraint(
                fields=['tipodocumento', 'documento'],
                name='unique_responsable_documento',
                violation_error_message='Ya existe un responsable con este documento.'
            ),
        ]

    def __str__(self):
        return f"{self.nombres} {self.apellidos}"

    def clean(self):
        """
        Validaci√≥n de documento seg√∫n tipo (Per√∫)
        """
        super().clean()

        if self.documento and self.tipodocumento:
            tipo = self.tipodocumento.nombre.upper()
            doc = self.documento.strip()

            # DNI: 8 d√≠gitos exactos
            if tipo == 'DNI':
                if not re.match(r'^\d{8}$', doc):
                    raise CoreValidationError({
                        'documento': 'El DNI debe tener exactamente 8 d√≠gitos.'
                    })

            # Carnet de Extranjer√≠a: 9 d√≠gitos
            elif tipo in ['CE', 'CARNET DE EXTRANJERIA', 'CARNET DE EXTRANJER√çA']:
                if not re.match(r'^\d{9}$', doc):
                    raise CoreValidationError({
                        'documento': 'El Carnet de Extranjer√≠a debe tener 9 d√≠gitos.'
                    })

            # Pasaporte: Alfanum√©rico, 9-12 caracteres
            elif tipo == 'PASAPORTE':
                if not re.match(r'^[A-Z0-9]{9,12}$', doc):
                    raise CoreValidationError({
                        'documento': 'El Pasaporte debe tener entre 9 y 12 caracteres alfanum√©ricos.'
                    })

            # RUC: 11 d√≠gitos
            elif tipo == 'RUC':
                if not re.match(r'^\d{11}$', doc):
                    raise CoreValidationError({
                        'documento': 'El RUC debe tener exactamente 11 d√≠gitos.'
                    })

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)
```

---

## üìù CAMBIOS EN SERIALIZERS

### **1. TrabajadorSerializer (Refactorizado)**

```python
class TrabajadorSerializer(serializers.ModelSerializer):
    tipodocumento = serializers.PrimaryKeyRelatedField(queryset=TipoDocumento.objects.all())
    tipodocumento_nombre = serializers.CharField(source='tipodocumento.nombre', read_only=True)
    usuario = UsuarioSerializer()
    estado = serializers.ChoiceField(choices=Estado.ESTADO_CHOICES, required=False, default=Estado.ACTIVO)

    # ‚úÖ Email calculado desde Usuario (read-only)
    email = serializers.EmailField(source='usuario.email', read_only=True)

    class Meta:
        model = Trabajador
        fields = [
            'id', 'nombres', 'apellidos', 'email', 'telefono',
            'tipodocumento', 'tipodocumento_nombre', 'documento', 'usuario', 'estado'
        ]

    def validate(self, attrs):
        """
        Validaci√≥n completa
        """
        # Validar documento duplicado
        documento = attrs.get('documento')
        tipodocumento = attrs.get('tipodocumento')

        if documento and tipodocumento:
            query = Trabajador.objects.filter(
                documento=documento,
                tipodocumento=tipodocumento
            )
            if self.instance:
                query = query.exclude(id=self.instance.id)

            if query.exists():
                raise serializers.ValidationError({
                    "documento": "Ya existe un trabajador con este documento."
                })

        return attrs

    def create(self, validated_data):
        usuario_data = validated_data.pop('usuario')
        usuario_serializer = UsuarioSerializer(data=usuario_data)
        usuario_serializer.is_valid(raise_exception=True)
        usuario = usuario_serializer.save()

        trabajador = Trabajador.objects.create(usuario=usuario, **validated_data)
        return trabajador

    def update(self, instance, validated_data):
        usuario_data = validated_data.pop('usuario', None)

        if usuario_data:
            usuario_serializer = UsuarioSerializer(
                instance.usuario,
                data=usuario_data,
                partial=True
            )
            usuario_serializer.is_valid(raise_exception=True)
            usuario_serializer.save()

        for attr, value in validated_data.items():
            setattr(instance, attr, value)

        instance.save()
        return instance
```

---

### **2. ResponsableSerializer (Refactorizado)**

```python
class ResponsableSerializer(serializers.ModelSerializer):
    # ‚ùå ELIMINADO: usuario = UsuarioSerializer()
    tipodocumento = serializers.PrimaryKeyRelatedField(queryset=TipoDocumento.objects.all())
    tipodocumento_nombre = serializers.CharField(source='tipodocumento.nombre', read_only=True)
    mascotas = MascotaSerializer(many=True, read_only=True)

    class Meta:
        model = Responsable
        fields = [
            'id', 'nombres', 'apellidos', 'email', 'telefono', 'direccion',
            'ciudad', 'documento', 'tipodocumento', 'tipodocumento_nombre',
            'emergencia', 'mascotas'
        ]

    def validate(self, attrs):
        """
        Validaci√≥n completa
        """
        # Validar email √∫nico
        email = attrs.get('email')
        if email:
            query = Responsable.objects.filter(email=email)
            if self.instance:
                query = query.exclude(id=self.instance.id)

            if query.exists():
                raise serializers.ValidationError({
                    "email": "Este email ya est√° registrado por otro responsable."
                })

        # Validar documento √∫nico
        documento = attrs.get('documento')
        tipodocumento = attrs.get('tipodocumento')

        if documento and tipodocumento:
            query = Responsable.objects.filter(
                documento=documento,
                tipodocumento=tipodocumento
            )
            if self.instance:
                query = query.exclude(id=self.instance.id)

            if query.exists():
                raise serializers.ValidationError({
                    "documento": "Ya existe un responsable con este documento."
                })

        return attrs

    def create(self, validated_data):
        # ‚úÖ Simplificado: No hay usuario
        responsable = Responsable.objects.create(**validated_data)
        return responsable

    def update(self, instance, validated_data):
        # ‚úÖ Simplificado: Solo actualizar campos directos
        for attr, value in validated_data.items():
            setattr(instance, attr, value)

        instance.save()
        return instance
```

---

## üóÉÔ∏è MIGRACI√ìN DE DATOS

### **Script 1: Migrar Responsables (Eliminar Usuario)**

```python
# migracion_responsables.py
import os
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'huellitas.settings')
django.setup()

from api.models import Responsable, Usuario

print("=" * 60)
print("MIGRACION: Responsables sin Usuario")
print("=" * 60)

for responsable in Responsable.objects.all():
    print(f"\nResponsable: {responsable.nombres} {responsable.apellidos}")
    print(f"  Email Responsable: {responsable.email}")
    print(f"  Email Usuario: {responsable.usuario.email}")

    # Si est√°n desincronizados, usar el email del Usuario (m√°s reciente)
    if responsable.email != responsable.usuario.email:
        print(f"  [SYNC] Actualizando email de Responsable a Usuario.email")
        responsable.email = responsable.usuario.email

    # Guardar el ID del usuario para eliminarlo despu√©s
    usuario_id = responsable.usuario.id

    # Desasociar el usuario (esto se hace en la migraci√≥n)
    # responsable.usuario = None
    # responsable.save()

    print(f"  [INFO] Usuario {usuario_id} se eliminar√° en migraci√≥n")

print("\n" + "=" * 60)
print("IMPORTANTE: Este script es solo para an√°lisis.")
print("La eliminaci√≥n de Usuario se hace en la migraci√≥n de Django.")
print("=" * 60)
```

---

### **Script 2: Limpiar Duplicados Actuales**

```python
# limpiar_duplicados_actual.py
import os
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'huellitas.settings')
django.setup()

from api.models import Trabajador, Responsable

print("=" * 60)
print("LIMPIEZA DE DUPLICADOS")
print("=" * 60)

# === TRABAJADORES ===
print("\n=== TRABAJADORES ===")

# Caso 1: junior alvines (71448712)
junior = Trabajador.objects.get(id='fe80d13b-8f49-4487-b793-124259541bd7')
print(f"1. {junior.nombres} {junior.apellidos}")
print(f"   Documento actual: {junior.documento}")
print(f"   [ACCION] Cambiar documento a: 71448713")
# junior.documento = '71448713'
# junior.save()

# Caso 2: Ximena Alvines (71448712) - mantener original
ximena = Trabajador.objects.get(id='4e84f660-c2d0-4779-b47c-54db4317486f')
print(f"2. {ximena.nombres} {ximena.apellidos}")
print(f"   Documento actual: {ximena.documento}")
print(f"   [OK] Mantener documento: 71448712")

# === RESPONSABLES ===
print("\n=== RESPONSABLES ===")

# Caso 1: Maria Garcia Lopez (12345678)
maria = Responsable.objects.get(id='c93ecbf0-90cc-4586-aa57-e87040354fed')
print(f"1. {maria.nombres} {maria.apellidos}")
print(f"   Documento actual: {maria.documento}")
print(f"   [ACCION] Cambiar documento a: 87654321")
# maria.documento = '87654321'
# maria.save()

# Caso 2: Juan Carlos Perez Lopez (12345678) - mantener original
juan = Responsable.objects.get(id='f0a9e302-03a9-4e54-804f-2a01b21c5188')
print(f"2. {juan.nombres} {juan.apellidos}")
print(f"   Documento actual: {juan.documento}")
print(f"   [OK] Mantener documento: 12345678")

print("\n" + "=" * 60)
print("DESCOMENTA LAS LINEAS .save() PARA APLICAR CAMBIOS")
print("=" * 60)
```

---

## üìã PASOS DE IMPLEMENTACI√ìN

### **Fase 1: Backup**
```bash
# Backup de base de datos
pg_dump -U huellitas -d Huellitas > backup_pre_migracion.sql
```

### **Fase 2: Limpiar Duplicados Actuales**
```bash
python limpiar_duplicados_actual.py
# Revisar cambios propuestos
# Descomentar .save() y ejecutar de nuevo
```

### **Fase 3: Modificar Modelos**
- Eliminar campo `Trabajador.email`
- Agregar `@property email` en Trabajador
- Eliminar campo `Responsable.usuario`
- Agregar `clean()` en ambos modelos
- Agregar `Meta.constraints` en ambos modelos

### **Fase 4: Crear Migraci√≥n**
```bash
python manage.py makemigrations --name="remove_redundant_email_fields"
```

**IMPORTANTE:** La migraci√≥n autom√°tica puede fallar. Necesitar√°s:

1. **Para Responsable.usuario:**
```python
# En la migraci√≥n generada, ANTES de RemoveField:
migrations.RunPython(
    migrate_responsable_emails,  # Sincronizar emails
    migrations.RunPython.noop
),
migrations.RemoveField(
    model_name='responsable',
    name='usuario',
),
# DESPU√âS, eliminar usuarios hu√©rfanos de Responsables
```

2. **Para Trabajador.email:**
```python
# M√°s simple, solo remover campo
migrations.RemoveField(
    model_name='trabajador',
    name='email',
),
```

### **Fase 5: Aplicar Migraci√≥n**
```bash
python manage.py migrate
```

### **Fase 6: Actualizar Serializers**
- Modificar `TrabajadorSerializer`
- Modificar `ResponsableSerializer`
- Eliminar referencias a campos eliminados

### **Fase 7: Testing**
```bash
# Test crear trabajador
# Test crear responsable
# Test editar trabajador
# Test validaci√≥n DNI (8 d√≠gitos)
# Test validaci√≥n documento duplicado
```

---

## üìä CAMBIOS EN FRONTEND

### **Antes (Trabajador):**
```typescript
interface Trabajador {
  email: string;  // ‚ùå Campo directo
  usuario: {
    email: string;  // Mismo email
    rol: string;
  }
}
```

### **Despu√©s (Trabajador):**
```typescript
interface Trabajador {
  email: string;  // ‚úÖ Calculado desde usuario.email (read-only)
  usuario: {
    email: string;  // Fuente √∫nica de verdad
    rol: string;
  }
}

// Al crear/editar, SOLO enviar usuario.email:
const data = {
  nombres: "Juan",
  apellidos: "Perez",
  // ‚ùå NO enviar: email: "juan@gmail.com",
  usuario: {
    email: "juan@gmail.com",  // ‚úÖ Solo aqu√≠
    rol: "Veterinario"
  }
}
```

---

### **Antes (Responsable):**
```typescript
interface Responsable {
  email: string;
  usuario: {      // ‚ùå Ya no existe
    email: string;
    rol: string;
  }
}
```

### **Despu√©s (Responsable):**
```typescript
interface Responsable {
  email: string;  // ‚úÖ Un solo email (para contacto)
  // ‚ùå NO hay campo usuario
}

// Al crear/editar:
const data = {
  nombres: "Carlos",
  apellidos: "Rodriguez",
  email: "carlos@gmail.com",  // ‚úÖ Un solo email
  // ‚ùå NO enviar campo usuario
}
```

---

## ‚úÖ VALIDACI√ìN DE DOCUMENTOS PERUANOS

### **Ejemplos de Validaci√≥n:**

```python
# DNI v√°lido
documento = "71448712"  # ‚úÖ 8 d√≠gitos
documento = "12345678"  # ‚úÖ 8 d√≠gitos
documento = "1234567"   # ‚ùå Solo 7 d√≠gitos
documento = "123456789" # ‚ùå 9 d√≠gitos

# Carnet de Extranjer√≠a v√°lido
documento = "123456789"  # ‚úÖ 9 d√≠gitos
documento = "12345678"   # ‚ùå Solo 8 d√≠gitos

# Pasaporte v√°lido
documento = "ABC123456"   # ‚úÖ 9 caracteres alfanum√©ricos
documento = "PER1234567"  # ‚úÖ 10 caracteres
documento = "12345"       # ‚ùå Solo 5 caracteres

# RUC v√°lido
documento = "20123456789"  # ‚úÖ 11 d√≠gitos
documento = "2012345678"   # ‚ùå Solo 10 d√≠gitos
```

---

## üéØ BENEFICIOS DE ESTA SOLUCI√ìN

### ‚úÖ **Simplicidad**
- Un solo email por modelo (no hay duplicaci√≥n)
- Menos campos que sincronizar
- Menos c√≥digo que mantener

### ‚úÖ **Integridad**
- Constraints √∫nicos a nivel de BD
- Validaci√≥n espec√≠fica para Per√∫
- Imposible crear duplicados

### ‚úÖ **Performance**
- Menos JOINs necesarios
- Menos datos duplicados
- Queries m√°s r√°pidas

### ‚úÖ **Seguridad**
- Responsables sin acceso al sistema (no necesitan Usuario)
- Trabajadores con email √∫nico (no hay confusi√≥n)
- Validaci√≥n de documentos seg√∫n est√°ndar peruano

---

## ‚ùì FAQ

### **P1: ¬øPor qu√© eliminar Responsable.usuario?**
**R:** Porque el Responsable NO tiene acceso al sistema. No hace login. Solo necesita un email para contacto, no para autenticaci√≥n.

### **P2: ¬øPor qu√© eliminar Trabajador.email?**
**R:** Porque es redundante. Ya tiene `usuario.email` que se usa para login. Tener dos emails causa confusi√≥n y desincronizaci√≥n.

### **P3: ¬øQu√© pasa con Responsables existentes?**
**R:** En la migraci√≥n, se copia `Usuario.email` ‚Üí `Responsable.email`, luego se elimina el Usuario asociado.

### **P4: ¬øC√≥mo sabe el frontend que cambi√≥?**
**R:** Para Trabajador: El campo `email` sigue existiendo (read-only). Para Responsable: Ya no env√≠a `usuario` en las requests.

### **P5: ¬øDNI de 7 d√≠gitos?**
**R:** DNI en Per√∫ es **siempre 8 d√≠gitos** desde 1995. Si tienes DNI antiguos de 7 d√≠gitos, agregar validaci√≥n especial.

---

## üöÄ SIGUIENTE PASO

¬øQuieres que implemente estos cambios?

Confirma y procedo a:
1. ‚úÖ Crear script de limpieza de duplicados
2. ‚úÖ Modificar modelos
3. ‚úÖ Crear migraci√≥n personalizada
4. ‚úÖ Actualizar serializers
5. ‚úÖ Documentar para frontend
